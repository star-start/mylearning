'''
Desc:
File: /main.py
File Created: Saturday, 3rd December 2022 5:59:30 pm
-----
Copyright (c) 2022 Camel Lu
'''
from time import sleep
import time
from threading import Thread
import requests
from fake_useragent import UserAgent

from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry

# requests.adapters.DEFAULT_RETRIES = 10 # 增加重连次数
# s = requests.session()
# s.keep_alive = False # 关闭多余连接

session = requests.Session()
retry = Retry(connect=5, backoff_factor=0.5)
adapter = HTTPAdapter(max_retries=retry)
session.mount('http://', adapter)
session.mount('https://', adapter)


class TruliaApi:

    # def __init__(self):
    # self.api_key = api_key
    def get_client_headers(self, *, content_type='application/x-www-form-urlencoded;charset=utf-8', referer='https://www.zillow.com/'):
        cookies = '_pxhd=zwHyBs-7sgIR3fgWKfzOEnRXzsg7lK09mUKDSgBP-arC4DStuhRU4HHvTDegD7LckzQ5dwnJ7nGeOlgPyHRedA==:a7znBuF7nFObZQ2pQBvjZwHxctUqZZjTX0X5wzZtnQWHwxd9E-WrR73hoO/WfZU6TVFTnVM5I/qAsC1UoWs35M09xEoH7vMOVnAyARyAY2U=; _csrfSecret=24944M4CL741PbkKFk2oPpXk; tlftmusr=221208rmkznp98qs9hzzkvsrc4v3m216; s_fid=547C70CF62738889-1486A16C1B74EE36; s_cc=true; zjs_user_id=null; zg_anonymous_id=%221ab0cd99-5246-4931-b59f-2140cb98ca4d%22; zjs_anonymous_id=%22221208rmkznp98qs9hzzkvsrc4v3m216%22; s_vi=[CS]v1|31C909C86D8E87DF-600010282FA82D83[CE]; _lr_geo_location=SG; branch_banner_closed=true; QSI_S_ZN_aVrRbuAaSuA7FBz=v:0:0; pxcts=39e109a2-7717-11ed-8fc5-4d7446776d72; _pxvid=0b2fa4e0-7717-11ed-a445-445a664c4452; _pxff_tm=1; trul_visitTimer=1670517639694_1670519900294; OptanonConsent=isIABGlobal=false&datestamp=Fri+Dec+09+2022+01%3A18%3A20+GMT%2B0800+(China+Standard+Time)&version=5.8.0&landingPath=NotLandingPage&AwaitingReconsent=false&groups=1%3A1%2C0_234869%3A1%2C3%3A1%2C4%3A1%2C0_234866%3A1%2C0_234867%3A1%2C0_234868%3A1%2C0_240782%3A1%2C0_240783%3A1%2C0_240780%3A1%2C0_234871%3A1%2C0_240781%3A1%2C0_234872%3A1%2C0_234873%3A1%2C0_234874%3A1%2C0_234875%3A1%2C0_234876%3A1%2C0_234877%3A1; _px3=b6c2f28c4f88ad170c4478a6c40ee804c6d4dcc228ed3e57297999636592c3a6:Sn3SL+DwMjVsE7YsMmg6Hb8VN2DJfQJm2ACeZ0g8d0BdL6hyrxokUjXyGQk6zR8eWBDg1nK5zqwDDqKkOlcLyA==:1000:aDasg0cz8lInvxVFQqQam8hwvPa2VmnN/TdvXV/eVOtf5p7E872KJ0boNl07yvuPk/kQTcJzz/vq65ik587bwn3MmLsihifQGjmUbWjdJMZ+uk5o1EH2/I07/30xx4/a+ArROUYa4eHHrTsT+13/LxMBnLgO9ntu/S5UjHUiUsLHl4L575nXxbWjlxjcNpUpYX6IreKOR+eQb99XwwK6Eg==; s_sq=truliacom%3D%2526c.%2526a.%2526activitymap.%2526page%253Dbuy%25253Asrp%25253Ahybrid%2526link%253D3%2526region%253DresultsColumn%2526pageIDType%253D1%2526.activitymap%2526.a%2526.c%2526pid%253Dbuy%25253Asrp%25253Ahybrid%2526pidt%253D1%2526oid%253Dhttps%25253A%25252F%25252Fwww.trulia.com%25252FCA%25252F3_p%25252F%2526ot%253DA; temp_interactedWith=buy:srp:hybrid|below%20list:pagination%20link%203'
        ua = UserAgent()

        headers = {
            'Content-Type': content_type,
            # 'Authority': 'www.zillow.com',
            # 'Client-Id': 'home-details_fs-sp_bootstrap',
            'User-Agent': ua.random.lstrip(),
            # 'Origin': 'https://www.zillow.com/',
            # 'Referer': referer,
            'Cookie': cookies
        }
        return headers

    def get_search_list(self, *, page=1):
        opname = 'WEB_searchHomes'
        transactionId = 'client-d42d38dc-9996-4dfe-abf0-2e153237f9f3'
        url = 'https://www.trulia.com/graphql?opname={0}&transactionId={1}'.format(opname, transactionId)
        headers = self.get_client_headers(content_type='application/json')
        city = 'CA'
        limit = 100
        payload = {
            "operationName": "WEB_searchHomes",
            "variables": {
                "limit": limit,
                "shouldIncludeSrpFragment": True,
                "shouldIncludeHeaderAndFooterFragment": True,
                "defaultSortType": None,
                "defaultSortDirection": None,
                "includeNearBy": True,
                "isSwipeableFactsEnabled": False,
                "isSeoEnhancementEnabled": True,
                "isNearbyCitiesEnabled": True,
                "recommendedSearchesVariation": "VARIATION_1",
                "heroImageFallbacks": ["STREET_VIEW", "SATELLITE_VIEW"],
                "url": "/" + city + "/" + str(page)+"_p/",
                "isBot": False,
                "isSPA": False
            },
            "query": "query WEB_searchHomes($url: String!, $limit: Int = " + str(limit) + ", $heroImageFallbacks: [MEDIA_HeroImageFallbackTypes!], $isBot: Boolean!, $isSPA: Boolean!, $shouldIncludeSrpFragment: Boolean = true, $shouldIncludeHeaderAndFooterFragment: Boolean = true, $defaultSortType: SEARCHDETAILS_SortType = null, $defaultSortDirection: SEARCHDETAILS_SortDirection = null, $includeNearBy: Boolean = false, $isSwipeableFactsEnabled: Boolean = false, $isSeoEnhancementEnabled: Boolean = false, $isNearbyCitiesEnabled: Boolean = false, $recommendedSearchesVariation: HOME_RecommendedSearchesVariation = null) {\n  searchHomesByUrl(url: $url, limit: $limit, defaultSortType: $defaultSortType, defaultSortDirection: $defaultSortDirection, includeNearBy: $includeNearBy) {\n    ...SearchResultsContentFragment @include(if: $shouldIncludeSrpFragment)\n    ...HeaderAndFooterFragment @include(if: $shouldIncludeHeaderAndFooterFragment)\n    ...SearchResultsBranchBannerFragmnet @include(if: $shouldIncludeSrpFragment)\n    __typename\n  }\n  viewer {\n    ...Viewer\n    __typename\n  }\n}\n\nfragment SearchResultsContentFragment on SEARCH_Result {\n  currentUrl\n  canonicalUrl\n  adTargetings @skip(if: $isBot)\n  ...SearchResultHeaderLocationFragment\n  ...SearchResultsMarketDetailsFragment @include(if: $isBot)\n  ...SearchResultsHomesListFragment\n  ...SearchResultsPaginationFragment\n  ...SearchResultsBreadcrumbsFragment\n  ...SearchResultsPopularLocationsFragment\n  ...SearchResultsMapFragment\n  ...SearchResultsFooterCardFragment\n  ...SearchResultsFiltersFragment\n  ...SearchResultsProviderAttributionFragment\n  ...SearchResultsRentalJsonLdSchemaFragment\n  homes {\n    ...SearchResultsRentalResultJsonLdSchemaFragment\n    __typename\n  }\n  details {\n    ...SearchDetailsFragment\n    canonicalUrl\n    __typename\n  }\n  names {\n    title\n    locationName\n    description\n    __typename\n  }\n  tracking {\n    key\n    value\n    __typename\n  }\n  pageDisplayFlags {\n    isAdvertisingRestricted\n    __typename\n  }\n  nearByHomes {\n    ...HomeDetailsCardFragment\n    ...HomeDetailsCardPhotosFragment\n    ...SingleFamilyResidenceJsonLdFragment\n    ...OpenHouseJsonLdFragment\n    ...HomeDetailsCallToActionFragment\n    ...HomeDetailsTopThirdFragment @include(if: $isSPA)\n    ...HomeDetailsGroupInsightsFragment @include(if: $isSwipeableFactsEnabled)\n    __typename\n  }\n  openHomes {\n    inPerson {\n      ...OpenHouseJsonLdFragment\n      __typename\n    }\n    __typename\n  }\n  ...SearchResultsTopNeighborhoods\n  ...SearchResultsRecommendedSearches\n  isSrpIndexable\n  preferences {\n    isSaved @skip(if: $isBot)\n    __typename\n  }\n  __typename\n}\n\nfragment SearchResultHeaderLocationFragment on SEARCH_Result {\n  location {\n    ... on SEARCH_ResultLocationState {\n      state\n      __typename\n    }\n    ... on SEARCH_ResultLocationBoundingBox {\n      city\n      state\n      __typename\n    }\n    ... on SEARCH_ResultLocationCity {\n      city\n      state\n      __typename\n    }\n    ... on SEARCH_ResultLocationCounty {\n      county\n      state\n      __typename\n    }\n    ... on SEARCH_ResultLocationNeighborhood {\n      city\n      state\n      neighborhood\n      __typename\n    }\n    ... on SEARCH_ResultLocationPostalCode {\n      city\n      state\n      postalCode\n      __typename\n    }\n    ... on SEARCH_ResultLocationSchool {\n      name\n      __typename\n    }\n    ... on SEARCH_ResultLocationSchoolDistrict {\n      city\n      state\n      schoolDistrictIds\n      __typename\n    }\n    __typename\n  }\n  recentSearches {\n    title\n    type\n    url\n    locationDetails {\n      cities {\n        city\n        state\n        __typename\n      }\n      counties\n      neighborhoods\n      zips\n      schoolDistricts\n      school {\n        id\n        name\n        __typename\n      }\n      __typename\n    }\n    formattedFilterLists\n    __typename\n  }\n  pageDisplayFlags {\n    shouldDisplayZINCAttribution\n    __typename\n  }\n  __typename\n}\n\nfragment SearchResultsHomesListFragment on SEARCH_Result {\n  homeCounts {\n    agentListingsCount {\n      value\n      __typename\n    }\n    otherListingsCount {\n      value\n      __typename\n    }\n    __typename\n  }\n  homes {\n    ...HomeDetailsCardFragment\n    ...HomeDetailsCardPhotosFragment\n    ...SingleFamilyResidenceJsonLdFragment\n    ...OpenHouseJsonLdFragment\n    ...HomeDetailsCallToActionFragment\n    ...HomeDetailsTopThirdFragment @include(if: $isSPA)\n    ...HomeDetailsGroupInsightsFragment @include(if: $isSwipeableFactsEnabled)\n    __typename\n  }\n  ...FailedSearchFragment\n  names {\n    headerTag\n    subHeaderTag\n    resultsIncludeDescription\n    searchResultsMapTag\n    nearByHeaderTag\n    nearBySubHeaderTag\n    formattedFilterLists\n    __typename\n  }\n  totalHomes\n  details {\n    ...SearchResultsSortFragment\n    __typename\n  }\n  emptyState {\n    noHomesFoundText\n    noHomesFoundCTAText\n    reason\n    __typename\n  }\n  moreHomesInformation {\n    title\n    body\n    ctaTitle\n    __typename\n  }\n  dynamicFilters {\n    neighborhoods {\n      value\n      displayText\n      isActive\n      count\n      __typename\n    }\n    __typename\n  }\n  isSaveSearchCardVisible\n  __typename\n}\n\nfragment HomeDetailsCardFragment on HOME_Details {\n  __typename\n  location {\n    city\n    stateCode\n    zipCode\n    fullLocation: formattedLocation(formatType: STREET_CITY_STATE_ZIP)\n    partialLocation: formattedLocation(formatType: STREET_ONLY)\n    __typename\n  }\n  price {\n    formattedPrice\n    __typename\n  }\n  url\n  tags(include: MINIMAL) {\n    level\n    formattedName\n    icon {\n      vectorImage {\n        svg\n        __typename\n      }\n      __typename\n    }\n    __typename\n  }\n  fullTags: tags {\n    level\n    formattedName\n    icon {\n      vectorImage {\n        svg\n        __typename\n      }\n      __typename\n    }\n    __typename\n  }\n  floorSpace {\n    formattedDimension\n    __typename\n  }\n  lotSize {\n    ... on HOME_SingleDimension {\n      formattedDimension(minDecimalDigits: 2, maxDecimalDigits: 2)\n      __typename\n    }\n    __typename\n  }\n  bedrooms {\n    formattedValue(formatType: TWO_LETTER_ABBREVIATION)\n    __typename\n  }\n  bathrooms {\n    formattedValue(formatType: TWO_LETTER_ABBREVIATION)\n    __typename\n  }\n  isSaveable\n  preferences {\n    isSaved\n    isSavedByCoShopper @include(if: false)\n    __typename\n  }\n  metadata {\n    compositeId\n    legacyIdForSave\n    __typename\n  }\n  tracking {\n    key\n    value\n    __typename\n  }\n  displayFlags {\n    showMLSLogoOnListingCard\n    addAttributionProminenceOnListCard\n    __typename\n  }\n  ... on HOME_RoomForRent {\n    numberOfRoommates\n    availableDate: formattedAvailableDate(dateFormat: \"MMM D\")\n    providerListingId\n    __typename\n  }\n  ... on HOME_RentalCommunity {\n    activeListing {\n      provider {\n        summary(formatType: SHORT)\n        listingSource {\n          logoUrl\n          __typename\n        }\n        __typename\n      }\n      __typename\n    }\n    location {\n      communityLocation: formattedLocation(formatType: STREET_COMMUNITY_NAME)\n      __typename\n    }\n    providerListingId\n    __typename\n  }\n  ... on HOME_Property {\n    currentStatus {\n      isRecentlySold\n      isRecentlyRented\n      isActiveForRent\n      isActiveForSale\n      isOffMarket\n      isForeclosure\n      __typename\n    }\n    priceChange {\n      priceChangeDirection\n      __typename\n    }\n    activeListing {\n      provider {\n        summary(formatType: SHORT)\n        extraShortSummary: summary(formatType: EXTRA_SHORT)\n        listingSource {\n          logoUrl\n          __typename\n        }\n        __typename\n      }\n      dateListed\n      __typename\n    }\n    lastSold {\n      provider {\n        summary(formatType: SHORT)\n        extraShortSummary: summary(formatType: EXTRA_SHORT)\n        listingSource {\n          logoUrl\n          __typename\n        }\n        __typename\n      }\n      __typename\n    }\n    providerListingId\n    __typename\n  }\n  ... on HOME_FloorPlan {\n    priceChange {\n      priceChangeDirection\n      __typename\n    }\n    provider {\n      summary(formatType: SHORT)\n      __typename\n    }\n    __typename\n  }\n}\n\nfragment HomeDetailsCardPhotosFragment on HOME_Details {\n  media {\n    __typename\n    heroImage(fallbacks: $heroImageFallbacks) {\n      url {\n        small\n        medium\n        __typename\n      }\n      webpUrl: url(compression: webp) {\n        small\n        medium\n        __typename\n      }\n      __typename\n    }\n    photos {\n      url {\n        small\n        medium\n        __typename\n      }\n      webpUrl: url(compression: webp) {\n        small\n        medium\n        __typename\n      }\n      __typename\n    }\n  }\n  __typename\n}\n\nfragment HomeDetailsCallToActionFragment on HOME_Details {\n  hasPrequalifiers\n  leadFormCallToAction(context: CARD, appendOneClick: true) {\n    callToActionType\n    callToActionDisplayLabel\n    supportsCancellableSubmission\n    buttonStyle\n    __typename\n  }\n  __typename\n}\n\nfragment FailedSearchFragment on SEARCH_Result {\n  names {\n    locationName\n    __typename\n  }\n  location {\n    __typename\n    ... on SEARCH_ResultLocationPointOfInterest {\n      exactCoordinates {\n        latitude\n        longitude\n        __typename\n      }\n      __typename\n    }\n  }\n  __typename\n}\n\nfragment SearchResultsSortFragment on SEARCHDETAILS_Details {\n  filters {\n    sort {\n      type\n      ascending\n      __typename\n    }\n    __typename\n  }\n  __typename\n}\n\nfragment SingleFamilyResidenceJsonLdFragment on HOME_Property {\n  location {\n    partialLocation: formattedLocation(formatType: STREET_ONLY)\n    city\n    stateCode\n    zipCode\n    coordinates {\n      latitude\n      longitude\n      __typename\n    }\n    __typename\n  }\n  __typename\n}\n\nfragment OpenHouseDateFragment on HOME_Listing {\n  openHouses {\n    ... on HOME_ScheduledOpenHouse {\n      start\n      end\n      startHour: formattedStartTime(format: \"hA\")\n      endHour: formattedEndTime(format: \"hA\")\n      __typename\n    }\n    __typename\n  }\n  __typename\n}\n\nfragment OpenHouseJsonLdFragment on HOME_Details {\n  ... on HOME_Property {\n    url\n    location {\n      formattedLocation\n      partialLocation: formattedLocation(formatType: STREET_ONLY)\n      city\n      stateCode\n      zipCode\n      coordinates {\n        latitude\n        longitude\n        __typename\n      }\n      __typename\n    }\n    activeForSaleListing {\n      ...OpenHouseDateFragment\n      __typename\n    }\n    activeForRentListing {\n      ...OpenHouseDateFragment\n      __typename\n    }\n    media {\n      hasThreeDHome\n      hasVideo\n      photos {\n        url {\n          large\n          __typename\n        }\n        __typename\n      }\n      __typename\n    }\n    price {\n      ... on HOME_SinglePrice {\n        price\n        currencyCode\n        __typename\n      }\n      __typename\n    }\n    ...VirtualTourJsonLdSchemaFragment\n    __typename\n  }\n  ... on HOME_RoomForRent {\n    activeForRentListing {\n      ...OpenHouseDateFragment\n      __typename\n    }\n    __typename\n  }\n  __typename\n}\n\nfragment VirtualTourJsonLdSchemaFragment on HOME_Details {\n  price {\n    ... on HOME_SinglePrice {\n      price\n      __typename\n    }\n    ... on HOME_ValuationPrice {\n      price\n      __typename\n    }\n    ... on HOME_ListingSinglePrice {\n      price\n      __typename\n    }\n    __typename\n  }\n  __typename\n}\n\nfragment HomeDetailsTopThirdFragment on HOME_Details {\n  bathrooms {\n    summaryBathrooms: formattedValue(formatType: COMMON_ABBREVIATION)\n    __typename\n  }\n  bedrooms {\n    summaryBedrooms: formattedValue(formatType: COMMON_ABBREVIATION)\n    __typename\n  }\n  floorSpace {\n    formattedDimension\n    __typename\n  }\n  location {\n    city\n    coordinates {\n      latitude\n      longitude\n      __typename\n    }\n    neighborhoodName\n    stateCode\n    zipCode\n    cityStateZipAddress: formattedLocation(formatType: CITY_STATE_ZIP)\n    homeFormattedAddress: formattedLocation\n    summaryFormattedLocation: formattedLocation(formatType: STREET_COMMUNITY_BUILDER)\n    __typename\n  }\n  media {\n    metaTagHeroImages: heroImage(fallbacks: $heroImageFallbacks) {\n      url {\n        desktop: custom(size: {width: 2048, height: 200})\n        __typename\n      }\n      __typename\n    }\n    topThirdHeroImages: heroImage(fallbacks: $heroImageFallbacks) {\n      __typename\n      url {\n        extraSmallSrc: custom(size: {width: 375, height: 275})\n        smallSrc: custom(size: {width: 570, height: 275})\n        mediumSrc: custom(size: {width: 768, height: 500})\n        largeSrc: custom(size: {width: 992, height: 500})\n        hiDipExtraSmallSrc: custom(size: {width: 1125, height: 825})\n        hiDpiSmallSrc: custom(size: {width: 1710, height: 825})\n        hiDpiMediumSrc: custom(size: {width: 2048, height: 1536})\n        __typename\n      }\n      webpUrl: url(compression: webp) {\n        extraSmallWebpSrc: custom(size: {width: 375, height: 275})\n        smallWebpSrc: custom(size: {width: 570, height: 275})\n        mediumWebpSrc: custom(size: {width: 768, height: 500})\n        largeWebpSrc: custom(size: {width: 992, height: 500})\n        hiDipExtraSmallWebpSrc: custom(size: {width: 1125, height: 825})\n        hiDpiSmallWebpSrc: custom(size: {width: 1710, height: 825})\n        hiDpiMediumWebpSrc: custom(size: {width: 2048, height: 1536})\n        __typename\n      }\n    }\n    totalPhotoCount\n    __typename\n  }\n  metadata {\n    compositeId\n    currentListingId\n    __typename\n  }\n  pageText {\n    title\n    metaDescription\n    __typename\n  }\n  price {\n    formattedPrice\n    ... on HOME_LastSoldPrice {\n      formattedPriceDifferencePercent\n      formattedSoldDate(dateFormat: \"MMM D, YYYY\")\n      listingPrice {\n        formattedPrice(formatType: SHORT_ABBREVIATION)\n        __typename\n      }\n      priceDifferencePercent\n      pricePerDimension {\n        formattedDimension\n        __typename\n      }\n      __typename\n    }\n    ... on HOME_ForeclosureEstimatePrice {\n      price\n      typeDescription\n      __typename\n    }\n    ... on HOME_PriceRange {\n      currencyCode\n      max\n      min\n      __typename\n    }\n    ... on HOME_SinglePrice {\n      currencyCode\n      price\n      __typename\n    }\n    __typename\n  }\n  tracking {\n    key\n    value\n    __typename\n  }\n  url\n  ... on HOME_Property {\n    currentStatus {\n      isOffMarket\n      isRecentlySold\n      isForeclosure\n      isActiveForRent\n      isActiveForSale\n      isRecentlyRented\n      label\n      __typename\n    }\n    __typename\n  }\n  ... on HOME_RentalCommunity {\n    location {\n      rentalCommunityFormattedLocation: formattedLocation(formatType: STREET_COMMUNITY_NAME)\n      __typename\n    }\n    __typename\n  }\n  __typename\n}\n\nfragment HomeDetailsGroupInsightsFragment on HOME_Details {\n  ... on HOME_Property {\n    groupedInsights {\n      insights {\n        ... on HOME_FeatureInsights {\n          insightTags {\n            formattedName\n            __typename\n          }\n          __typename\n        }\n        ... on HOME_SmartInsights {\n          insightTags {\n            formattedName\n            __typename\n          }\n          __typename\n        }\n        ... on HOME_ContextualPhrases {\n          phrases {\n            description\n            __typename\n          }\n          __typename\n        }\n        __typename\n      }\n      __typename\n    }\n    __typename\n  }\n  __typename\n}\n\nfragment SearchResultsPaginationFragment on SEARCH_Result {\n  totalHomes\n  currentUrl\n  details {\n    filters {\n      page\n      limit\n      __typename\n    }\n    __typename\n  }\n  __typename\n}\n\nfragment SearchResultsBreadcrumbsFragment on SEARCH_Result {\n  navigation {\n    label\n    url\n    linkType\n    __typename\n  }\n  __typename\n}\n\nfragment SearchResultsRentalJsonLdSchemaFragment on SEARCH_Result {\n  details {\n    searchType\n    __typename\n  }\n  location {\n    ... on SEARCH_ResultLocationCity {\n      city\n      state\n      __typename\n    }\n    ... on SEARCH_ResultLocationState {\n      state\n      __typename\n    }\n    __typename\n  }\n  __typename\n}\n\nfragment SearchResultsRentalResultJsonLdSchemaFragment on HOME_Property {\n  location {\n    city\n    stateCode\n    formattedLocation\n    zipCode\n    coordinates {\n      latitude\n      longitude\n      __typename\n    }\n    __typename\n  }\n  propertyType {\n    value\n    __typename\n  }\n  currentStatus {\n    isActiveForRent\n    __typename\n  }\n  __typename\n}\n\nfragment SearchResultsPopularLocationsFragment on SEARCH_Result {\n  surroundingPopularLocations {\n    forRent {\n      label\n      url\n      __typename\n    }\n    forSale {\n      label\n      url\n      __typename\n    }\n    sold {\n      label\n      url\n      __typename\n    }\n    __typename\n  }\n  __typename\n}\n\nfragment SearchResultsMapFragment on SEARCH_Result {\n  mapEmptyState: emptyState(format: SHORT) {\n    noHomesFoundText\n    __typename\n  }\n  details {\n    filters {\n      zoom\n      __typename\n    }\n    __typename\n  }\n  names {\n    searchResultsMapTag\n    __typename\n  }\n  location {\n    boundingBox {\n      minCoordinates {\n        latitude\n        longitude\n        __typename\n      }\n      maxCoordinates {\n        latitude\n        longitude\n        __typename\n      }\n      __typename\n    }\n    ... on SEARCH_ResultLocationCity {\n      locationId\n      __typename\n    }\n    ... on SEARCH_ResultLocationCounty {\n      locationId\n      __typename\n    }\n    ... on SEARCH_ResultLocationNeighborhood {\n      locationId\n      __typename\n    }\n    ... on SEARCH_ResultLocationPostalCode {\n      locationId\n      __typename\n    }\n    ... on SEARCH_ResultLocationState {\n      locationId\n      __typename\n    }\n    __typename\n  }\n  ...HomeMarkerLayersContainerFragment\n  ...HoverCardLayerFragment\n  __typename\n}\n\nfragment HomeMarkerLayersContainerFragment on SEARCH_Result {\n  ...HomeMarkersLayerFragment\n  __typename\n}\n\nfragment HomeMarkersLayerFragment on SEARCH_Result {\n  homes {\n    location {\n      coordinates {\n        latitude\n        longitude\n        __typename\n      }\n      __typename\n    }\n    url\n    metadata {\n      compositeId\n      __typename\n    }\n    ...HomeMarkerFragment\n    __typename\n  }\n  nearByHomes {\n    ...HomeMarkerFragment\n    __typename\n  }\n  __typename\n}\n\nfragment HomeMarkerFragment on HOME_Details {\n  media {\n    hasThreeDHome\n    __typename\n  }\n  location {\n    coordinates {\n      latitude\n      longitude\n      __typename\n    }\n    __typename\n  }\n  displayFlags {\n    enableMapPin\n    __typename\n  }\n  price {\n    calloutMarkerPrice: formattedPrice(formatType: SHORT_ABBREVIATION)\n    __typename\n  }\n  url\n  ... on HOME_Property {\n    activeForSaleListing {\n      openHouses {\n        formattedDay\n        __typename\n      }\n      __typename\n    }\n    __typename\n  }\n  ...HomeDetailsTopThirdFragment @include(if: $isSPA)\n  __typename\n}\n\nfragment HoverCardLayerFragment on SEARCH_Result {\n  homes {\n    ...HomeHoverCardFragment\n    __typename\n  }\n  nearByHomes {\n    ...HomeHoverCardFragment\n    __typename\n  }\n  __typename\n}\n\nfragment HomeHoverCardFragment on HOME_Details {\n  ...HomeDetailsCardFragment\n  ...HomeDetailsCardHeroFragment\n  ...HomeDetailsCardPhotosFragment\n  ...HomeDetailsGroupInsightsFragment @include(if: $isSwipeableFactsEnabled)\n  location {\n    coordinates {\n      latitude\n      longitude\n      __typename\n    }\n    __typename\n  }\n  displayFlags {\n    enableMapPin\n    showMLSLogoOnMapMarkerCard\n    __typename\n  }\n  __typename\n}\n\nfragment HomeDetailsCardHeroFragment on HOME_Details {\n  media {\n    heroImage(fallbacks: $heroImageFallbacks) {\n      url {\n        small\n        medium\n        __typename\n      }\n      webpUrl: url(compression: webp) {\n        small\n        __typename\n      }\n      __typename\n    }\n    __typename\n  }\n  __typename\n}\n\nfragment SearchResultsFiltersFragment on SEARCH_Result {\n  transitSystems {\n    name\n    iconUrl(format: SVG)\n    isSelected\n    filterLabel\n    __typename\n  }\n  homeCounts {\n    agentListingsCount {\n      formattedValue\n      __typename\n    }\n    otherListingsCount {\n      formattedValue\n      __typename\n    }\n    __typename\n  }\n  details {\n    searchType\n    ...SearchResultsSortFragment\n    filters {\n      isAlternateListingSource\n      price {\n        min\n        max\n        __typename\n      }\n      bedrooms {\n        min\n        max\n        __typename\n      }\n      bathrooms {\n        min\n        max\n        __typename\n      }\n      squareFeet {\n        min\n        max\n        __typename\n      }\n      hoaFee {\n        min\n        max\n        __typename\n      }\n      propertyTypes\n      lotSize {\n        min\n        max\n        __typename\n      }\n      mlsId\n      newListing {\n        range {\n          min\n          max\n          timestamp\n          __typename\n        }\n        daysAgo\n        __typename\n      }\n      recentlyReduced {\n        range {\n          min\n          max\n          timestamp\n          __typename\n        }\n        daysAgo\n        __typename\n      }\n      openHomes {\n        range {\n          min\n          max\n          timestamp\n          __typename\n        }\n        type\n        __typename\n      }\n      yearBuilt {\n        min\n        max\n        __typename\n      }\n      keywords\n      listingTypes\n      plus55Communities {\n        exclude\n        __typename\n      }\n      soldWithin\n      pets\n      furnished\n      rentalListingTags\n      isInverseSearch\n      __typename\n    }\n    __typename\n  }\n  __typename\n}\n\nfragment SearchResultsProviderAttributionFragment on SEARCH_Result {\n  providers {\n    listingSource {\n      logoUrl\n      attribution\n      alternativeSources {\n        name\n        url\n        __typename\n      }\n      disclaimer {\n        markdown\n        __typename\n      }\n      __typename\n    }\n    __typename\n  }\n  __typename\n}\n\nfragment SearchResultsMarketDetailsFragment on SEARCH_Result {\n  details {\n    location {\n      cities {\n        city\n        state\n        __typename\n      }\n      __typename\n    }\n    __typename\n  }\n  ...SearchResultsNeighborhoodsListFragment\n  ...MarketInsightsDataFragment\n  ...SearchResultsSummaryFragment\n  ...SearchResultsWhatLocalsSayFragment\n  __typename\n}\n\nfragment SearchResultsNeighborhoodsListFragment on SEARCH_Result {\n  surroundings(limit: 15) {\n    ...NeighborhoodCardFragment\n    ... on SURROUNDINGS_Neighborhood {\n      neighborhoodAttribution\n      __typename\n    }\n    __typename\n  }\n  __typename\n}\n\nfragment NeighborhoodCardFragment on SURROUNDINGS_Neighborhood {\n  name\n  ndpActive\n  ndpUrl\n  media(includeStoryMedia: false) {\n    heroImage {\n      ... on MEDIA_HeroImageMap {\n        url {\n          path: custom(size: {width: 136, height: 136, cropMode: fill}, zoomLevel: 1100)\n          __typename\n        }\n        __typename\n      }\n      ... on MEDIA_HeroImageStory {\n        url {\n          path: custom(size: {width: 136, height: 136, cropMode: fill})\n          __typename\n        }\n        __typename\n      }\n      ... on MEDIA_HeroImagePhoto {\n        url {\n          path: custom(size: {width: 136, height: 136, cropMode: fill})\n          __typename\n        }\n        __typename\n      }\n      __typename\n    }\n    __typename\n  }\n  localFacts {\n    forSaleStats {\n      min\n      max\n      __typename\n    }\n    homesForSaleCount\n    forRentStats {\n      min\n      max\n      __typename\n    }\n    homesForRentCount\n    soldHomesStats {\n      min\n      max\n      __typename\n    }\n    soldHomesCount\n    __typename\n  }\n  neighborhoodSearchUrlCTA {\n    forSale\n    forRent\n    __typename\n  }\n  __typename\n}\n\nfragment SearchResultsWhatLocalsSayFragment on SEARCH_Result {\n  searchLocationSurroundings {\n    locationId\n    name\n    ... on SURROUNDINGS_Neighborhood {\n      ndpType\n      ndpUrl\n      name\n      ndpActive\n      localUGC {\n        ... on SURROUNDINGS_LocalUGC {\n          ...LocalUGCFragment\n          __typename\n        }\n        __typename\n      }\n      __typename\n    }\n    ... on SURROUNDINGS_City {\n      localUGC {\n        ... on SURROUNDINGS_LocalUGC {\n          ...LocalUGCFragment\n          __typename\n        }\n        __typename\n      }\n      __typename\n    }\n    __typename\n  }\n  __typename\n}\n\nfragment LocalUGCFragment on SURROUNDINGS_LocalUGC {\n  title\n  stats {\n    attributes {\n      type\n      name\n      score\n      __typename\n    }\n    minimumResponseCount\n    __typename\n  }\n  localReviews {\n    categories {\n      id\n      displayName\n      reviewCount\n      callToAction\n      __typename\n    }\n    totalReviews\n    reviews(limitPerCategory: 8) {\n      id\n      text\n      context {\n        displayName\n        __typename\n      }\n      category {\n        id\n        displayName\n        __typename\n      }\n      dateCreated\n      reactionSummary {\n        counts {\n          helpful\n          __typename\n        }\n        viewerReactions {\n          helpful\n          __typename\n        }\n        __typename\n      }\n      flagSummary {\n        totalCount\n        __typename\n      }\n      __typename\n    }\n    __typename\n  }\n  __typename\n}\n\nfragment SearchResultsSummaryFragment on SEARCH_Result {\n  marketInsights(sourceAllFromZHVI: true) {\n    rentalMarketInsights {\n      medianRentalPriceAverageForPastYear\n      __typename\n    }\n    __typename\n  }\n  __typename\n}\n\nfragment MarketInsightsDataFragment on SEARCH_Result {\n  names {\n    locationName\n    __typename\n  }\n  ...PartialMarketInsightsDataFragment\n  surroundings(limit: 15) {\n    ...NeighborhoodDataFragment\n    ...CityDataFragment @include(if: $isNearbyCitiesEnabled)\n    __typename\n  }\n  __typename\n}\n\nfragment PartialMarketInsightsDataFragment on SEARCH_Result {\n  marketInsights(sourceAllFromZHVI: true) {\n    homeStatsByBedroomCount: statsByHomeFeature(featureType: BEDROOMS) {\n      displayName\n      featureStats {\n        displayName\n        homeValueIndexPrice\n        inventorySummary @include(if: $isNearbyCitiesEnabled)\n        ... on STATS_AND_TRENDS_HomeFeatureStat {\n          forSaleSearchUrl\n          __typename\n        }\n        __typename\n      }\n      summary {\n        summaryDescription\n        newListingsSearchUrl\n        newListingsSearchCta\n        __typename\n      }\n      __typename\n    }\n    affordability {\n      name\n      summary\n      trend {\n        value\n        formattedValue\n        date\n        formattedDate(dateFormat: \"MMMM YYYY\")\n        __typename\n      }\n      __typename\n    }\n    affordabilityAttribution\n    propertyCountByFeaturesAndStyles: statsByHomeFeature(featureType: POPULAR_FEATURES) @include(if: $isSeoEnhancementEnabled) {\n      displayName\n      featureStats {\n        displayName\n        inventorySummary\n        forSaleSearchUrl\n        __typename\n      }\n      __typename\n    }\n    __typename\n  }\n  __typename\n}\n\nfragment NeighborhoodDataFragment on SURROUNDINGS_Neighborhood {\n  name\n  forSaleNeighborhoodSearchCanonicalURL\n  localFacts {\n    homesForSaleCount\n    __typename\n  }\n  __typename\n}\n\nfragment CityDataFragment on SURROUNDINGS_City {\n  __typename\n  name\n  media {\n    heroImage {\n      url {\n        small\n        __typename\n      }\n      __typename\n    }\n    __typename\n  }\n  localFacts {\n    forSaleStats {\n      formattedPriceRange\n      __typename\n    }\n    homesForSaleCount\n    __typename\n  }\n  searchUrl {\n    forSale\n    __typename\n  }\n}\n\nfragment SearchResultsFooterCardFragment on SEARCH_Result {\n  homes {\n    ...HomeDetailsCardFragment\n    ...HomeDetailsCardPhotosFragment\n    ...HomeDetailsTopThirdFragment @include(if: $isSPA)\n    __typename\n  }\n  __typename\n}\n\nfragment SearchDetailsFragment on SEARCHDETAILS_Details {\n  searchType\n  location {\n    cities {\n      city\n      state\n      __typename\n    }\n    states {\n      state\n      __typename\n    }\n    counties\n    neighborhoods\n    zips\n    schoolDistricts\n    university {\n      id\n      name\n      __typename\n    }\n    school {\n      id\n      name\n      __typename\n    }\n    customArea {\n      latLngs {\n        latitude\n        longitude\n        __typename\n      }\n      encodedPolygon\n      __typename\n    }\n    commute {\n      type\n      maxTime\n      polygons {\n        latitude\n        longitude\n        __typename\n      }\n      __typename\n    }\n    pointOfInterest {\n      latitude\n      longitude\n      __typename\n    }\n    coordinates {\n      center {\n        latitude\n        longitude\n        __typename\n      }\n      southEast {\n        latitude\n        longitude\n        __typename\n      }\n      northEast {\n        latitude\n        longitude\n        __typename\n      }\n      southWest {\n        latitude\n        longitude\n        __typename\n      }\n      northWest {\n        latitude\n        longitude\n        __typename\n      }\n      __typename\n    }\n    radiusSize\n    __typename\n  }\n  filters {\n    bedrooms {\n      min\n      max\n      __typename\n    }\n    bathrooms {\n      min\n      max\n      __typename\n    }\n    price {\n      min\n      max\n      __typename\n    }\n    squareFeet {\n      min\n      max\n      __typename\n    }\n    hoaFee {\n      min\n      max\n      __typename\n    }\n    zoom\n    street\n    propertyTypes\n    lotSize {\n      min\n      max\n      __typename\n    }\n    mlsId\n    newListing {\n      range {\n        min\n        max\n        timestamp\n        __typename\n      }\n      daysAgo\n      __typename\n    }\n    openHomes {\n      range {\n        min\n        max\n        timestamp\n        __typename\n      }\n      __typename\n    }\n    percentChanged\n    recentlyReduced {\n      range {\n        min\n        max\n        timestamp\n        __typename\n      }\n      daysAgo\n      __typename\n    }\n    pricePerSquareFoot {\n      min\n      max\n      __typename\n    }\n    yearBuilt {\n      min\n      max\n      __typename\n    }\n    keywords\n    listingTypes\n    foreclosureTypes\n    discoveryGroup\n    sort {\n      type\n      ascending\n      __typename\n    }\n    soldWithin\n    pets\n    brokerFee\n    buildingAmenities\n    unitAmenities\n    furnished\n    rentalListingTags\n    landlordPays\n    page\n    offset\n    limit\n    transit {\n      system\n      line\n      station\n      __typename\n    }\n    propertyAmenityTypes\n    isInverseSearch\n    __typename\n  }\n  canonicalUrl\n  description\n  __typename\n}\n\nfragment SearchResultsTopNeighborhoods on SEARCH_Result {\n  topNeighborhoods: surroundings(limit: 6) {\n    ... on SURROUNDINGS_Neighborhood {\n      name\n      ndpUrl\n      localFacts {\n        forSaleStats {\n          min\n          max\n          __typename\n        }\n        homesForSaleCount\n        __typename\n      }\n      neighborhoodSearchUrlCTA {\n        forSale\n        forRent\n        __typename\n      }\n      __typename\n    }\n    __typename\n  }\n  __typename\n}\n\nfragment SearchResultsRecommendedSearches on SEARCH_Result {\n  recommendedSearches(view: $recommendedSearchesVariation) {\n    title\n    subTitle\n    disclaimer\n    subTitleFormattedFilterLists\n    ctaText\n    searchUrl\n    homes {\n      ...HomeHoverCardFragment\n      __typename\n    }\n    __typename\n  }\n  __typename\n}\n\nfragment HeaderAndFooterFragment on SEARCH_Result {\n  primaryNavigation {\n    ...Header\n    __typename\n  }\n  secondaryNavigation {\n    ...Footer\n    __typename\n  }\n  __typename\n}\n\nfragment Header on PRIMARY_NAVIGATION_NavigationItem {\n  label\n  uri\n  description\n  children {\n    label\n    uri\n    description\n    children {\n      label\n      uri\n      __typename\n    }\n    __typename\n  }\n  __typename\n}\n\nfragment Footer on SECONDARY_NAVIGATION_SecondaryNavigation {\n  main {\n    label\n    uri\n    children {\n      label\n      uri\n      __typename\n    }\n    __typename\n  }\n  internal {\n    label\n    uri\n    children {\n      label\n      uri\n      isNoFollow\n      __typename\n    }\n    __typename\n  }\n  brand {\n    label\n    uri\n    children {\n      label\n      uri\n      __typename\n    }\n    __typename\n  }\n  __typename\n}\n\nfragment Viewer on USER_Viewer {\n  userStatus\n  userType\n  userId\n  loggedIn\n  name\n  email\n  profileImage {\n    small\n    __typename\n  }\n  permissions\n  userNavigation {\n    label\n    uri\n    description\n    children {\n      label\n      uri\n      __typename\n    }\n    __typename\n  }\n  optedOutOfSale\n  __typename\n}\n\nfragment SearchResultsBranchBannerFragmnet on SEARCH_Result {\n  location {\n    ... on SEARCH_ResultLocationState {\n      state\n      __typename\n    }\n    ... on SEARCH_ResultLocationBoundingBox {\n      city\n      state\n      __typename\n    }\n    ... on SEARCH_ResultLocationCity {\n      city\n      state\n      __typename\n    }\n    ... on SEARCH_ResultLocationNeighborhood {\n      city\n      state\n      neighborhood\n      __typename\n    }\n    ... on SEARCH_ResultLocationCounty {\n      county\n      state\n      __typename\n    }\n    ... on SEARCH_ResultLocationNeighborhood {\n      city\n      state\n      neighborhood\n      __typename\n    }\n    ... on SEARCH_ResultLocationPostalCode {\n      city\n      state\n      postalCode\n      __typename\n    }\n    ... on SEARCH_ResultLocationSchool {\n      city\n      state\n      schoolName: name\n      __typename\n    }\n    ... on SEARCH_ResultLocationCustomArea {\n      city\n      state\n      __typename\n    }\n    ... on SEARCH_ResultLocationPointOfInterest {\n      city\n      state\n      __typename\n    }\n    ... on SEARCH_ResultLocationSchoolDistrict {\n      city\n      state\n      schoolDistrictName: name\n      __typename\n    }\n    __typename\n  }\n  __typename\n}\n"
        }

        res = session.post(url, headers=headers, json=payload)
        sleep(1)
        try:
            if res.status_code == 200:
                res_json = res.json()
                # print(res_json)
                print("res_json", res_json['data']['searchHomesByUrl']['currentUrl'], res_json['data']['searchHomesByUrl']['totalHomes'], len(
                    res_json['data']['searchHomesByUrl']['homes']))
            else:
                print(res.content)
                raise ('中断')
        except (BaseException):
            print(res.content)
            raise BaseException

    def pressure_test(self, max=200):
        for i in range(max):
            self.get_search_list(page=i+1)
            print('i', i)


def bootstrap_thread(target_fn, thread_count=2, max=500):
    threaders = []
    start_time = time.time()
    for i in range(thread_count):
        t = Thread(target=target_fn, args=(max,))
        t.setDaemon(True)
        threaders.append(t)
        t.start()
    for threader in threaders:
        threader.join()
    end_time = time.time()
    print('run time is %s' % (end_time - start_time))


if __name__ == '__main__':
    trulia_api = TruliaApi()
    bootstrap_thread(trulia_api.pressure_test, 1, 500)
    print('ok')
